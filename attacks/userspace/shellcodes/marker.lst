     1                                  ;
     2                                  ; $Id: marker.s 330 2007-01-30 03:03:11Z lostrace $
     3                                  ;
     4                                  ; marker.s: a shellcode that is meant to be prefixed to other shellcodes.
     5                                  ;	during execution it will possibly load a new stackpointer and
     6                                  ;	NOT the "marker", so an attacker cann see that it was executed.
     7                                  ;
     8                                  ; Copyright (C) 2006,2007
     9                                  ; losTrace aka "David R. Piegdon"
    10                                  ;
    11                                  ; This program is free software; you can redistribute it and/or modify
    12                                  ; it under the terms of the GNU General Public License version 2, as
    13                                  ; published by the Free Software Foundation.
    14                                  ;
    15                                  ; This program is distributed in the hope that it will be useful,
    16                                  ; but WITHOUT ANY WARRANTY; without even the implied warranty of
    17                                  ; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    18                                  ; GNU General Public License for more details.
    19                                  ;
    20                                  ; You should have received a copy of the GNU General Public License
    21                                  ; along with this program; if not, write to the Free Software
    22                                  ; Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
    23                                  ;
    24                                  
    25                                  BITS 32
    26                                  
    27 00000000 E808000000              	call near	string_get_address
    28 00000005 11EEEE11                	dd		0x11eeee11		; marker (endianness-insensitive!)
    29 00000009 FFFFFFFF                	dd		0xffffffff		; before mark: new SP, after mark: old SP
    30                                  string_get_address:
    31                                  	; get address of data
    32 0000000D 5A                      	pop		edx
    33                                  	; save old ESP and if new has been set by supervisor, set new ESP
    34 0000000E 8B4204                  	mov		eax, [edx+4]
    35 00000011 896204                  	mov		[edx+4], esp
    36 00000014 3DFFFFFFFF              	cmp		eax,0xffffffff
    37 00000019 7402                    	je		set_esp_done
    38 0000001B 89C4                    	mov		esp, eax
    39                                  set_esp_done:
    40                                  	; NOT the mark
    41 0000001D 8B02                    	mov		eax, [edx]
    42 0000001F F7D0                    	not		eax
    43 00000021 8902                    	mov		[edx], eax
    44                                  
    45                                  ; continue with other shellcode
